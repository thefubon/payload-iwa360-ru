# 📧 Настройка Email для форм обратной связи

## 🎯 Текущее состояние

✅ **API route обновлен** - используется библиотека Resend  
✅ **Пакет установлен** - `resend@6.1.2`  
⚠️ **Требуется настройка** - необходимо добавить API ключи в `.env`

---

## 🚀 Быстрая настройка (3 минуты)

### Шаг 1: Создайте аккаунт в Resend

1. Перейдите на [resend.com](https://resend.com)
2. Зарегистрируйтесь (есть бесплатный план)
3. Подтвердите email

### Шаг 2: Получите API ключ

1. Войдите в панель Resend
2. Перейдите в раздел **API Keys**
3. Нажмите **Create API Key**
4. Скопируйте сгенерированный ключ (он начинается с `re_`)

### Шаг 3: Добавьте домен (опционально, но рекомендуется)

**Для тестирования:**
- Можно использовать `onboarding@resend.dev` (по умолчанию)
- Ограничение: письма отправляются только на ваш email

**Для production:**
1. В Resend перейдите в **Domains**
2. Нажмите **Add Domain**
3. Введите ваш домен (например: `yourdomain.com`)
4. Добавьте DNS записи (SPF, DKIM)
5. Дождитесь верификации

### Шаг 4: Создайте `.env` файл

В корне проекта создайте файл `.env` и добавьте:

```bash
# DATABASE (если еще нет)
DATABASE_URI=postgresql://user:password@localhost:5432/dbname

# PAYLOAD SECRET (если еще нет)
PAYLOAD_SECRET=your-secret-key-here-minimum-32-characters

# ============================================
# EMAIL НАСТРОЙКИ
# ============================================

# API ключ от Resend
RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# Email отправителя (для тестирования используйте onboarding@resend.dev)
RESEND_FROM_EMAIL=noreply@yourdomain.com

# Или для тестирования:
# RESEND_FROM_EMAIL=onboarding@resend.dev

# NEXT.JS
NEXT_PUBLIC_SERVER_URL=http://localhost:3000
```

### Шаг 5: Перезапустите сервер

```bash
pnpm dev
```

---

## ✅ Проверка работы

1. Откройте форму на сайте
2. Заполните и отправьте форму
3. Проверьте консоль терминала:
   - ✅ Если видите: `✅ Email успешно отправлен`
   - ❌ Если видите: `⚠️ RESEND_API_KEY не найден` - добавьте ключ в `.env`
4. Проверьте почту получателя

---

## 📋 Как это работает

### 1. **При отправке формы:**
```typescript
// API route автоматически:
1. Сохраняет данные в базу (коллекция form-submissions)
2. Отправляет email администратору (если указан emailTo)
3. Отправляет подтверждение пользователю (если включено)
```

### 2. **Email администратору:**
- Тема: из настроек формы (`emailSubject`)
- Получатель: из настроек формы (`emailTo`)
- Содержит: таблицу со всеми заполненными полями

### 3. **Email пользователю (опционально):**
- Отправляется, если в настройках формы включено `sendEmailToUser`
- Требует наличие поля типа "Email" в форме
- Содержит: текст успеха из настроек формы

---

## 🎨 Примеры email шаблонов

### Email администратору:
```
┌────────────────────────────────────┐
│ Новая заявка с формы: Контакты     │
├────────────────────────────────────┤
│ Имя:      Иван Иванов              │
│ Email:    ivan@example.com         │
│ Телефон:  +7 (916) 123-45-67       │
│ Сообщение: Хочу узнать о продукте  │
├────────────────────────────────────┤
│ Это автоматическое уведомление     │
│ с сайта IWA360                     │
└────────────────────────────────────┘
```

### Email пользователю:
```
┌────────────────────────────────────┐
│         Спасибо!                   │ ← Градиент
├────────────────────────────────────┤
│ Ваше сообщение успешно отправлено. │
│ Мы свяжемся с вами в ближайшее     │
│ время.                             │
│                                    │
│ С уважением,                       │
│ Команда IWA360                     │
└────────────────────────────────────┘
```

---

## 🔧 Настройка в админке

### Для каждой формы можно настроить:

1. **Основные email настройки:**
   - Email получателя (`emailTo`)
   - Тема письма (`emailSubject`)

2. **Подтверждение пользователю:**
   - Включить/выключить отправку (`sendEmailToUser`)
   - Тема письма пользователю (`userEmailSubject`)

3. **Экран успеха:**
   - Заголовок (`successTitle`)
   - Сообщение (`successMessage`)
   - Показывать иконку (`showSuccessIcon`)

---

## 🆓 Лимиты бесплатного плана Resend

- ✅ 100 писем в день
- ✅ 3,000 писем в месяц
- ✅ 1 домен
- ✅ Все функции API

**Для production:** рекомендуется перейти на платный план ($20/мес = 50,000 писем)

---

## 🔒 Альтернативные сервисы

Если не хотите использовать Resend, можете интегрировать:

### 1. **SendGrid**
```typescript
import sgMail from '@sendgrid/mail'
sgMail.setApiKey(process.env.SENDGRID_API_KEY)
await sgMail.send({ from, to, subject, html })
```

### 2. **AWS SES**
```typescript
import { SESClient, SendEmailCommand } from '@aws-sdk/client-ses'
const client = new SESClient({ region: 'us-east-1' })
await client.send(new SendEmailCommand({ ... }))
```

### 3. **Nodemailer (SMTP)**
```typescript
import nodemailer from 'nodemailer'
const transporter = nodemailer.createTransport({ ... })
await transporter.sendMail({ from, to, subject, html })
```

---

## ❓ Troubleshooting

### Проблема: "Email не приходит"

**Решение:**
1. Проверьте `.env` файл - есть ли `RESEND_API_KEY`
2. Проверьте консоль - должно быть `✅ Email успешно отправлен`
3. Проверьте спам-папку
4. Проверьте лимиты Resend (если превышены)
5. Проверьте верификацию домена в Resend

### Проблема: "Domain not verified"

**Решение:**
1. Используйте `onboarding@resend.dev` для тестирования
2. Для production добавьте DNS записи в настройках домена

### Проблема: "API key invalid"

**Решение:**
1. Пересоздайте API ключ в Resend
2. Убедитесь, что ключ начинается с `re_`
3. Перезапустите сервер после изменения `.env`

---

## 📞 Поддержка

- **Resend Docs:** [resend.com/docs](https://resend.com/docs)
- **Resend Support:** support@resend.com
- **Status Page:** [status.resend.com](https://status.resend.com)

---

## ✅ Чек-лист финальной проверки

- [ ] Создан аккаунт в Resend
- [ ] Получен API ключ
- [ ] API ключ добавлен в `.env` файл
- [ ] Сервер перезапущен
- [ ] Форма отправлена для теста
- [ ] Email пришел на почту
- [ ] В консоли видно `✅ Email успешно отправлен`

---

**🎉 Готово! Теперь все формы автоматически отправляют email!**

